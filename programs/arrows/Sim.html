<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Sim</title>
    <link rel="stylesheet" href="../../css/default.css" type="text/css" media="screen" title="default">
    <link rel="stylesheet" href="../../css/syntax.css" type="text/css">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description" content="Troels Henriksen's piece of the web.  Mostly about programming.">
    <meta name="keywords" content="Braintwist, Brainfuck, Lisp, Common Lisp Troels Henriksen, Brainfork, Esoteric programming language, programming, Haskell, functional programming, Futhark">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <div id="header">
      <div class="superHeader">

        <div class="right">
          <span class="doNotDisplay">Related sites:</span>
          <ul>
            <li><a href="https://github.com/Athas/sigkill.dk">github</a></li>
            
            <li><a href="../.././programs/arrows/Sim.lhs">source</a></li>
            
          </ul>
        </div>

      </div>

      <div class="midHeader">
        <h1 class="headerTitle"><a href="../../">SIGKILL <span id="headerSubTitle">-9</span></a></h1>
      </div>

      <div class="subHeader">
        <ul class="menu0"><li><a href="../../blog/">blog/</a></li><li><a href="../../hacks/">hacks/</a></li><li><a href="../../links.html">links</a></li><li><a href="../../me/">me/</a></li><li><a href="../../programs/" class="thisPage">programs/</a></li><li><a href="../../projects/">projects/</a></li><li><a href="../../writings/">writings/</a></li></ul><ul class="menu1"><li><a href="../../programs/arrows/" class="thisPage">arrows/</a></li><li><a href="../../programs/sigkill.html">sigkill</a></li><li><a href="../../programs/stepping.html">stepping</a></li></ul><ul class="menu2"><li><a href="../../programs/arrows/Circuits.html">Circuits</a></li><li><a href="../../programs/arrows/Sim.html" class="thisPage">Sim</a></li></ul>
      </div>
    </div>

    <div id="content">
      <h1 id="simulation-arrows"><a href="#simulation-arrows" id="simulation-arrows-link" class="titlelink" title="simulation-arrows">Simulation arrows</a></h1>
<p>Simple update of the simulation arrows from <em>Programming with Arrows</em> to work with the modern Arrow libraries.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">{-# LANGUAGE Arrows #-}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">module</span> <span class="dt">Sim</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">--  discrete event simulation library.</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co">-- This time, every channel always carries a value, and an *initial* value must</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co">-- be supplied before simulation starts.</span></a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">import</span> <span class="dt">Control.Category</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">import</span> <span class="dt">Control.Monad</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw">import</span> <span class="dt">Control.Monad.Fix</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">import</span> <span class="dt">Control.Arrow</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">import</span> <span class="dt">Data.IORef</span></a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">import</span> <span class="dt">Prelude</span> <span class="kw">hiding</span> ((.), id)</a>
<a class="sourceLine" id="cb1-15" title="15"></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="kw">type</span> <span class="dt">Time</span> <span class="fu">=</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb1-17" title="17"></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="ot">infinity ::</span> <span class="dt">Time</span></a>
<a class="sourceLine" id="cb1-19" title="19">infinity <span class="fu">=</span> <span class="dv">1</span><span class="fu">/</span><span class="dv">0</span></a>
<a class="sourceLine" id="cb1-20" title="20"></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="kw">data</span> <span class="dt">Event</span> a <span class="fu">=</span> <span class="dt">Event</span> {<span class="ot">time::</span><span class="dt">Time</span>,<span class="ot"> value::</span>a}</a>
<a class="sourceLine" id="cb1-22" title="22"></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="kw">instance</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> <span class="dt">Show</span> (<span class="dt">Event</span> a) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-24" title="24">  <span class="fu">show</span> t <span class="fu">=</span> <span class="fu">show</span> (value t)<span class="fu">++</span><span class="st">&quot;@&quot;</span><span class="fu">++show</span> (time t)</a>
<a class="sourceLine" id="cb1-25" title="25"></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="co">-- The simulation arrow: given initial value of input signal, deliver initial</span></a>
<a class="sourceLine" id="cb1-27" title="27"><span class="co">-- value of output signal and a running simulation.</span></a>
<a class="sourceLine" id="cb1-28" title="28"><span class="co">-- invariant: no output event should precede the first input.</span></a>
<a class="sourceLine" id="cb1-29" title="29"></a>
<a class="sourceLine" id="cb1-30" title="30"><span class="kw">newtype</span> <span class="dt">Sim</span> m a b <span class="fu">=</span> <span class="dt">Sim</span> (a <span class="ot">-&gt;</span> m (b, <span class="dt">State</span> m a b))</a>
<a class="sourceLine" id="cb1-31" title="31"></a>
<a class="sourceLine" id="cb1-32" title="32"><span class="ot">sim ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m (b, <span class="dt">State</span> m a b)) <span class="ot">-&gt;</span> <span class="dt">Sim</span> m a b</a>
<a class="sourceLine" id="cb1-33" title="33">sim f <span class="fu">=</span> <span class="dt">Sim</span> <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-34" title="34">  (b,s) <span class="ot">&lt;-</span> f a</a>
<a class="sourceLine" id="cb1-35" title="35">  <span class="fu">return</span> (b,quiescent s)</a>
<a class="sourceLine" id="cb1-36" title="36"></a>
<a class="sourceLine" id="cb1-37" title="37"><span class="ot">quiescent ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">State</span> m a b <span class="ot">-&gt;</span> <span class="dt">State</span> m a b</a>
<a class="sourceLine" id="cb1-38" title="38">quiescent (<span class="dt">Lift</span> m) <span class="fu">=</span> <span class="dt">Lift</span> (liftM quiescent m)</a>
<a class="sourceLine" id="cb1-39" title="39">quiescent (<span class="dt">Wait</span> t s k) <span class="fu">=</span> wait t (quiescent s) k</a>
<a class="sourceLine" id="cb1-40" title="40">quiescent (<span class="dt">Ready</span> _ _) <span class="fu">=</span> <span class="fu">error</span> <span class="st">&quot;Trying to output before first input&quot;</span></a>
<a class="sourceLine" id="cb1-41" title="41"></a>
<a class="sourceLine" id="cb1-42" title="42"><span class="co">-- running simulations.</span></a>
<a class="sourceLine" id="cb1-43" title="43"><span class="co">-- invariant: output events are in non-decreasing time order,</span></a>
<a class="sourceLine" id="cb1-44" title="44"><span class="co">--            output events do not precede inputs or timeouts they depend on,</span></a>
<a class="sourceLine" id="cb1-45" title="45"><span class="co">--            enforced by smart constructors</span></a>
<a class="sourceLine" id="cb1-46" title="46"></a>
<a class="sourceLine" id="cb1-47" title="47"><span class="kw">data</span> <span class="dt">State</span> m a b <span class="fu">=</span> <span class="dt">Ready</span> (<span class="dt">Event</span> b) (<span class="dt">State</span> m a b)</a>
<a class="sourceLine" id="cb1-48" title="48">                 <span class="fu">|</span> <span class="dt">Lift</span> (m (<span class="dt">State</span> m a b))</a>
<a class="sourceLine" id="cb1-49" title="49">                 <span class="fu">|</span> <span class="dt">Wait</span> <span class="dt">Time</span> (<span class="dt">State</span> m a b) (<span class="dt">Event</span> a <span class="ot">-&gt;</span> <span class="dt">State</span> m a b)</a>
<a class="sourceLine" id="cb1-50" title="50"></a>
<a class="sourceLine" id="cb1-51" title="51"><span class="ot">ready ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Event</span> a1 <span class="ot">-&gt;</span> <span class="dt">State</span> m a a1 <span class="ot">-&gt;</span> <span class="dt">State</span> m a a1</a>
<a class="sourceLine" id="cb1-52" title="52">ready e r <span class="fu">=</span> <span class="dt">Ready</span> e (checkSequence (<span class="st">&quot;Ready &quot;</span><span class="fu">++show</span> (time e)) (time e) r)</a>
<a class="sourceLine" id="cb1-53" title="53"></a>
<a class="sourceLine" id="cb1-54" title="54"><span class="ot">lift ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> m (<span class="dt">State</span> m a b) <span class="ot">-&gt;</span> <span class="dt">State</span> m a b</a>
<a class="sourceLine" id="cb1-55" title="55">lift <span class="fu">=</span> <span class="dt">Lift</span></a>
<a class="sourceLine" id="cb1-56" title="56"></a>
<a class="sourceLine" id="cb1-57" title="57"><span class="ot">wait ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span></a>
<a class="sourceLine" id="cb1-58" title="58">        <span class="dt">Time</span> <span class="ot">-&gt;</span> <span class="dt">State</span> m a b <span class="ot">-&gt;</span> (<span class="dt">Event</span> a <span class="ot">-&gt;</span> <span class="dt">State</span> m a b) <span class="ot">-&gt;</span> <span class="dt">State</span> m a b</a>
<a class="sourceLine" id="cb1-59" title="59">wait t f k <span class="fu">=</span> <span class="dt">Wait</span> t (checkSequence (<span class="st">&quot;Wait &quot;</span><span class="fu">++show</span> t) t f)</a>
<a class="sourceLine" id="cb1-60" title="60">                (\e <span class="ot">-&gt;</span> checkSequence</a>
<a class="sourceLine" id="cb1-61" title="61">                         (<span class="st">&quot;Wait &quot;</span><span class="fu">++show</span> t<span class="fu">++</span><span class="st">&quot; \\&quot;</span><span class="fu">++show</span> (time e)<span class="fu">++</span><span class="st">&quot; -&gt;&quot;</span>)</a>
<a class="sourceLine" id="cb1-62" title="62">                         (time e) (k e))</a>
<a class="sourceLine" id="cb1-63" title="63"></a>
<a class="sourceLine" id="cb1-64" title="64"><span class="co">-- ensure all outputs occur no earlier than t</span></a>
<a class="sourceLine" id="cb1-65" title="65"></a>
<a class="sourceLine" id="cb1-66" title="66"><span class="co">{-</span></a>
<a class="sourceLine" id="cb1-67" title="67"><span class="co">-- checkSequence is a version of causal which maintains a trace of events</span></a>
<a class="sourceLine" id="cb1-68" title="68"><span class="co">-- to report on an eventual failure. Useful for debugging new arrows.</span></a>
<a class="sourceLine" id="cb1-69" title="69"><span class="co">-- If debugging is unnecessary, it can be replaced by causal.</span></a>
<a class="sourceLine" id="cb1-70" title="70"></a>
<a class="sourceLine" id="cb1-71" title="71"><span class="co">checkSequence s t (Ready e f) | t &lt;= time e = Ready e f</span></a>
<a class="sourceLine" id="cb1-72" title="72"><span class="co">checkSequence s t (Lift m) =</span></a>
<a class="sourceLine" id="cb1-73" title="73"><span class="co">  Lift (liftM (checkSequence (s++&quot;\nLift&quot;) t) m)</span></a>
<a class="sourceLine" id="cb1-74" title="74"><span class="co">checkSequence s t (Wait t' f k) =</span></a>
<a class="sourceLine" id="cb1-75" title="75"><span class="co">  Wait t' (checkSequence (s++&quot;\nWait &quot;++show t') t f)</span></a>
<a class="sourceLine" id="cb1-76" title="76"><span class="co">    (\e -&gt; checkSequence</span></a>
<a class="sourceLine" id="cb1-77" title="77"><span class="co">             (s++&quot;\nWait &quot;++show t'++&quot; \\&quot;++show (time e)++&quot; -&gt;&quot;)</span></a>
<a class="sourceLine" id="cb1-78" title="78"><span class="co">             t (k e))</span></a>
<a class="sourceLine" id="cb1-79" title="79"><span class="co">checkSequence s t (Ready e f) =</span></a>
<a class="sourceLine" id="cb1-80" title="80"><span class="co">  error $ &quot;checkSequence: &quot;++show t++&quot; &gt; &quot;++show (time e)++&quot;\n&quot;++s++</span></a>
<a class="sourceLine" id="cb1-81" title="81"><span class="co">                          &quot;\nReady &quot;++show (time e)</span></a>
<a class="sourceLine" id="cb1-82" title="82"><span class="co">-}</span></a>
<a class="sourceLine" id="cb1-83" title="83"></a>
<a class="sourceLine" id="cb1-84" title="84"><span class="ot">checkSequence ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> t <span class="ot">-&gt;</span> <span class="dt">Time</span> <span class="ot">-&gt;</span> <span class="dt">State</span> m a b <span class="ot">-&gt;</span> <span class="dt">State</span> m a b</a>
<a class="sourceLine" id="cb1-85" title="85">checkSequence _ <span class="fu">=</span> causal</a>
<a class="sourceLine" id="cb1-86" title="86"></a>
<a class="sourceLine" id="cb1-87" title="87"><span class="ot">causal ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Time</span> <span class="ot">-&gt;</span> <span class="dt">State</span> m a b <span class="ot">-&gt;</span> <span class="dt">State</span> m a b</a>
<a class="sourceLine" id="cb1-88" title="88">causal t (<span class="dt">Ready</span> e f) <span class="fu">|</span> t <span class="fu">&lt;=</span> time e <span class="fu">=</span> <span class="dt">Ready</span> e f</a>
<a class="sourceLine" id="cb1-89" title="89">                     <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> <span class="fu">error</span> <span class="st">&quot;Violation of causality&quot;</span></a>
<a class="sourceLine" id="cb1-90" title="90">causal t (<span class="dt">Lift</span> m) <span class="fu">=</span> <span class="dt">Lift</span> (liftM (causal t) m)</a>
<a class="sourceLine" id="cb1-91" title="91">causal t (<span class="dt">Wait</span> t' s k) <span class="fu">=</span> <span class="dt">Wait</span> t' (causal t s) (causal t<span class="fu">.</span>k)</a>
<a class="sourceLine" id="cb1-92" title="92"></a>
<a class="sourceLine" id="cb1-93" title="93"><span class="co">-- run function supplies initial value and input events, and runs simulation</span></a>
<a class="sourceLine" id="cb1-94" title="94"><span class="co">-- in the underlying monad.</span></a>
<a class="sourceLine" id="cb1-95" title="95"><span class="ot">runSim ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Sim</span> m t t1 <span class="ot">-&gt;</span> t <span class="ot">-&gt;</span> [<span class="dt">Event</span> t] <span class="ot">-&gt;</span> m ()</a>
<a class="sourceLine" id="cb1-96" title="96">runSim (<span class="dt">Sim</span> f) a as <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-97" title="97">  (_,r) <span class="ot">&lt;-</span> f a</a>
<a class="sourceLine" id="cb1-98" title="98">  runState r as</a>
<a class="sourceLine" id="cb1-99" title="99"></a>
<a class="sourceLine" id="cb1-100" title="100"><span class="ot">runState ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">State</span> m t t1 <span class="ot">-&gt;</span> [<span class="dt">Event</span> t] <span class="ot">-&gt;</span> m ()</a>
<a class="sourceLine" id="cb1-101" title="101">runState (<span class="dt">Ready</span> _ s) as <span class="fu">=</span> runState s as</a>
<a class="sourceLine" id="cb1-102" title="102">runState (<span class="dt">Lift</span> m) as <span class="fu">=</span> <span class="kw">do</span> s <span class="ot">&lt;-</span> m</a>
<a class="sourceLine" id="cb1-103" title="103">                          runState s as</a>
<a class="sourceLine" id="cb1-104" title="104">runState (<span class="dt">Wait</span> t s _) []</a>
<a class="sourceLine" id="cb1-105" title="105">  <span class="fu">|</span> t<span class="fu">==</span>infinity <span class="fu">=</span> <span class="fu">return</span> ()             <span class="co">-- infinity never comes</span></a>
<a class="sourceLine" id="cb1-106" title="106">  <span class="fu">|</span> <span class="fu">otherwise</span>   <span class="fu">=</span> runState s []         <span class="co">-- timeout</span></a>
<a class="sourceLine" id="cb1-107" title="107">runState (<span class="dt">Wait</span> t s k) (a<span class="fu">:</span>as)</a>
<a class="sourceLine" id="cb1-108" title="108">  <span class="fu">|</span> t <span class="fu">&lt;=</span> time a <span class="fu">=</span> runState s (a<span class="fu">:</span>as)     <span class="co">-- timeout</span></a>
<a class="sourceLine" id="cb1-109" title="109">  <span class="fu">|</span> <span class="fu">otherwise</span>   <span class="fu">=</span> runState (k a) as     <span class="co">-- receive event</span></a>
<a class="sourceLine" id="cb1-110" title="110"></a>
<a class="sourceLine" id="cb1-111" title="111"><span class="co">-- Transition function when a simulation receives an input</span></a>
<a class="sourceLine" id="cb1-112" title="112"><span class="ot">after ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">State</span> m a a1 <span class="ot">-&gt;</span> <span class="dt">Event</span> a <span class="ot">-&gt;</span> <span class="dt">State</span> m a a1</a>
<a class="sourceLine" id="cb1-113" title="113"><span class="dt">Ready</span> b s  <span class="ot">`after`</span> a <span class="fu">=</span> ready b (s <span class="ot">`after`</span> a)</a>
<a class="sourceLine" id="cb1-114" title="114"><span class="dt">Lift</span> m     <span class="ot">`after`</span> a <span class="fu">=</span> lift (liftM (<span class="ot">`after`</span> a) m)</a>
<a class="sourceLine" id="cb1-115" title="115"><span class="dt">Wait</span> t s k <span class="ot">`after`</span> a</a>
<a class="sourceLine" id="cb1-116" title="116">  <span class="fu">|</span> t <span class="fu">&lt;=</span> time a <span class="fu">=</span> s <span class="ot">`after`</span> a</a>
<a class="sourceLine" id="cb1-117" title="117">  <span class="fu">|</span> <span class="fu">otherwise</span>   <span class="fu">=</span> k a</a>
<a class="sourceLine" id="cb1-118" title="118"></a>
<a class="sourceLine" id="cb1-119" title="119"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Category</span> (<span class="dt">Sim</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-120" title="120">  <span class="fu">id</span> <span class="fu">=</span> simArr <span class="fu">id</span></a>
<a class="sourceLine" id="cb1-121" title="121">  (<span class="fu">.</span>) <span class="fu">=</span> simComp</a>
<a class="sourceLine" id="cb1-122" title="122"></a>
<a class="sourceLine" id="cb1-123" title="123"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Arrow</span> (<span class="dt">Sim</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-124" title="124">  arr <span class="fu">=</span> simArr</a>
<a class="sourceLine" id="cb1-125" title="125">  first <span class="fu">=</span> simFirst</a>
<a class="sourceLine" id="cb1-126" title="126"></a>
<a class="sourceLine" id="cb1-127" title="127"><span class="ot">simArr ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> <span class="dt">Sim</span> m a b</a>
<a class="sourceLine" id="cb1-128" title="128">simArr f <span class="fu">=</span> sim <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="fu">return</span> (f a, s)</a>
<a class="sourceLine" id="cb1-129" title="129">  <span class="kw">where</span> s <span class="fu">=</span> waitInput (\a <span class="ot">-&gt;</span> ready (<span class="dt">Event</span> (time a) (f (value a))) s)</a>
<a class="sourceLine" id="cb1-130" title="130"></a>
<a class="sourceLine" id="cb1-131" title="131"><span class="ot">waitInput ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> (<span class="dt">Event</span> a <span class="ot">-&gt;</span> <span class="dt">State</span> m a b) <span class="ot">-&gt;</span> <span class="dt">State</span> m a b</a>
<a class="sourceLine" id="cb1-132" title="132">waitInput k <span class="fu">=</span> wait infinity <span class="fu">undefined</span> k</a>
<a class="sourceLine" id="cb1-133" title="133"></a>
<a class="sourceLine" id="cb1-134" title="134"><span class="ot">simComp ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Sim</span> m t1 b <span class="ot">-&gt;</span> <span class="dt">Sim</span> m t t1 <span class="ot">-&gt;</span> <span class="dt">Sim</span> m t b</a>
<a class="sourceLine" id="cb1-135" title="135"><span class="dt">Sim</span> g <span class="ot">`simComp`</span> <span class="dt">Sim</span> f <span class="fu">=</span> sim <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-136" title="136">  (b,sf) <span class="ot">&lt;-</span> f a</a>
<a class="sourceLine" id="cb1-137" title="137">  (c,sg) <span class="ot">&lt;-</span> g b</a>
<a class="sourceLine" id="cb1-138" title="138">  <span class="fu">return</span> (c,sf <span class="ot">`stateComp`</span> sg)</a>
<a class="sourceLine" id="cb1-139" title="139"></a>
<a class="sourceLine" id="cb1-140" title="140"><span class="ot">stateComp ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">State</span> m t1 t <span class="ot">-&gt;</span> <span class="dt">State</span> m t a1 <span class="ot">-&gt;</span> <span class="dt">State</span> m t1 a1</a>
<a class="sourceLine" id="cb1-141" title="141">sf <span class="ot">`stateComp`</span> <span class="dt">Ready</span> c sg <span class="fu">=</span> ready c (sf <span class="ot">`stateComp`</span> sg)</a>
<a class="sourceLine" id="cb1-142" title="142">sf <span class="ot">`stateComp`</span> <span class="dt">Lift</span> m <span class="fu">=</span> lift (liftM (sf <span class="ot">`stateComp`</span>) m)</a>
<a class="sourceLine" id="cb1-143" title="143"><span class="dt">Ready</span> b sf <span class="ot">`stateComp`</span> sg <span class="fu">=</span> sf <span class="ot">`stateComp`</span> (sg <span class="ot">`after`</span> b)</a>
<a class="sourceLine" id="cb1-144" title="144"><span class="dt">Lift</span> m <span class="ot">`stateComp`</span> sg <span class="fu">=</span> lift (liftM (<span class="ot">`stateComp`</span> sg) m)</a>
<a class="sourceLine" id="cb1-145" title="145"><span class="dt">Wait</span> tf sf kf <span class="ot">`stateComp`</span> <span class="dt">Wait</span> tg sg kg <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-146" title="146">  wait (<span class="fu">min</span> tf tg) timeout (\a <span class="ot">-&gt;</span> kf a <span class="ot">`stateComp`</span> <span class="dt">Wait</span> tg sg kg)</a>
<a class="sourceLine" id="cb1-147" title="147">  <span class="kw">where</span> timeout <span class="fu">|</span> tf<span class="fu">&lt;</span>tg     <span class="fu">=</span> sf <span class="ot">`stateComp`</span> <span class="dt">Wait</span> tg sg kg</a>
<a class="sourceLine" id="cb1-148" title="148">                <span class="fu">|</span> tf<span class="fu">&gt;</span>tg     <span class="fu">=</span> <span class="dt">Wait</span> tf sf kf <span class="ot">`stateComp`</span> sg</a>
<a class="sourceLine" id="cb1-149" title="149">                <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> sf <span class="ot">`stateComp`</span> sg</a>
<a class="sourceLine" id="cb1-150" title="150"></a>
<a class="sourceLine" id="cb1-151" title="151"><span class="ot">simFirst ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Sim</span> m a b <span class="ot">-&gt;</span> <span class="dt">Sim</span> m (a, c) (b, c)</a>
<a class="sourceLine" id="cb1-152" title="152">simFirst (<span class="dt">Sim</span> f) <span class="fu">=</span> sim <span class="fu">$</span> \(a,c) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-153" title="153">  (b,s) <span class="ot">&lt;-</span> f a</a>
<a class="sourceLine" id="cb1-154" title="154">  <span class="fu">return</span> ((b,c), stateFirst b c s)</a>
<a class="sourceLine" id="cb1-155" title="155"></a>
<a class="sourceLine" id="cb1-156" title="156"><span class="ot">stateFirst ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> b <span class="ot">-&gt;</span> c <span class="ot">-&gt;</span> <span class="dt">State</span> m a b <span class="ot">-&gt;</span> <span class="dt">State</span> m (a, c) (b, c)</a>
<a class="sourceLine" id="cb1-157" title="157">stateFirst b c (<span class="dt">Ready</span> b' s) <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-158" title="158">  wait (time b')</a>
<a class="sourceLine" id="cb1-159" title="159">       (ready (<span class="dt">Event</span> (time b') (value b',c)) (stateFirst (value b') c s))</a>
<a class="sourceLine" id="cb1-160" title="160">       (\(<span class="dt">Event</span> t' (a,c')) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-161" title="161">         ready (<span class="dt">Event</span> t' (b,c'))</a>
<a class="sourceLine" id="cb1-162" title="162">               (stateFirst b c' (ready b' (s <span class="ot">`after`</span> (<span class="dt">Event</span> t' a)))))</a>
<a class="sourceLine" id="cb1-163" title="163">stateFirst b c (<span class="dt">Lift</span> m) <span class="fu">=</span> <span class="dt">Lift</span> (liftM (stateFirst b c) m)</a>
<a class="sourceLine" id="cb1-164" title="164">stateFirst b c (<span class="dt">Wait</span> t s k) <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-165" title="165">  wait t (stateFirst b c s) <span class="fu">$</span> \(<span class="dt">Event</span> t' (a,c')) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-166" title="166">    ready (<span class="dt">Event</span> t' (b,c')) (stateFirst b c' (k (<span class="dt">Event</span> t' a)))</a>
<a class="sourceLine" id="cb1-167" title="167"></a>
<a class="sourceLine" id="cb1-168" title="168"><span class="co">-- Can we define a loop?</span></a>
<a class="sourceLine" id="cb1-169" title="169"></a>
<a class="sourceLine" id="cb1-170" title="170"><span class="kw">instance</span> <span class="dt">MonadFix</span> m <span class="ot">=&gt;</span> <span class="dt">ArrowLoop</span> (<span class="dt">Sim</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-171" title="171">  loop <span class="fu">=</span> simLoop</a>
<a class="sourceLine" id="cb1-172" title="172"></a>
<a class="sourceLine" id="cb1-173" title="173"><span class="ot">simLoop ::</span> <span class="dt">MonadFix</span> m <span class="ot">=&gt;</span> <span class="dt">Sim</span> m (t, t1) (b, t1) <span class="ot">-&gt;</span> <span class="dt">Sim</span> m t b</a>
<a class="sourceLine" id="cb1-174" title="174">simLoop (<span class="dt">Sim</span> f) <span class="fu">=</span> sim <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-175" title="175">  ((b,c),s) <span class="ot">&lt;-</span> mfix (\(<span class="fu">~</span>((_,c),_)) <span class="ot">-&gt;</span> f (a,c))</a>
<a class="sourceLine" id="cb1-176" title="176">  <span class="fu">return</span> (b,stateLoop a c [] s)</a>
<a class="sourceLine" id="cb1-177" title="177"></a>
<a class="sourceLine" id="cb1-178" title="178"><span class="co">-- stateLoop a c q s</span></a>
<a class="sourceLine" id="cb1-179" title="179"><span class="co">--   a = initial value of input</span></a>
<a class="sourceLine" id="cb1-180" title="180"><span class="co">--   c = initial value of state</span></a>
<a class="sourceLine" id="cb1-181" title="181"><span class="co">--   q = queue of future state changes</span></a>
<a class="sourceLine" id="cb1-182" title="182"><span class="co">--   s = running simulation (a,c) to (b,c)</span></a>
<a class="sourceLine" id="cb1-183" title="183"><span class="co">-- result is a running simulation from a to b, where state changes are</span></a>
<a class="sourceLine" id="cb1-184" title="184"><span class="co">-- fed back at the appropriate times.</span></a>
<a class="sourceLine" id="cb1-185" title="185"></a>
<a class="sourceLine" id="cb1-186" title="186"><span class="ot">stateLoop ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span></a>
<a class="sourceLine" id="cb1-187" title="187">             a <span class="ot">-&gt;</span> t <span class="ot">-&gt;</span> [(<span class="dt">Time</span>, t)] <span class="ot">-&gt;</span> <span class="dt">State</span> m (a, t) (b, t) <span class="ot">-&gt;</span> <span class="dt">State</span> m a b</a>
<a class="sourceLine" id="cb1-188" title="188">stateLoop a c q (<span class="dt">Ready</span> (<span class="dt">Event</span> t (b,c')) s) <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-189" title="189">  ready (<span class="dt">Event</span> t b) (stateLoop a c (q<span class="fu">++</span>[(t,c')]) s)</a>
<a class="sourceLine" id="cb1-190" title="190">stateLoop a c q (<span class="dt">Lift</span> m) <span class="fu">=</span> lift <span class="fu">$</span> liftM (stateLoop a c q) m</a>
<a class="sourceLine" id="cb1-191" title="191">stateLoop a c ((t',c')<span class="fu">:</span>q) (<span class="dt">Wait</span> t s k) <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-192" title="192">  wait (<span class="fu">min</span> t t') timeout <span class="fu">$</span> \(<span class="dt">Event</span> t'' a') <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-193" title="193">    stateLoop a' c ((t',c')<span class="fu">:</span>q) (k (<span class="dt">Event</span> t'' (a',c)))</a>
<a class="sourceLine" id="cb1-194" title="194">  <span class="kw">where</span> timeout <span class="fu">|</span> t'<span class="fu">&lt;</span>t      <span class="fu">=</span> stateLoop a c' q (k (<span class="dt">Event</span> t' (a,c')))</a>
<a class="sourceLine" id="cb1-195" title="195">                <span class="fu">|</span> t'<span class="fu">&gt;</span>t      <span class="fu">=</span> stateLoop a c ((t',c')<span class="fu">:</span>q) s</a>
<a class="sourceLine" id="cb1-196" title="196">                <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> stateLoop a c' q (s <span class="ot">`after`</span> <span class="dt">Event</span> t (a,c'))</a>
<a class="sourceLine" id="cb1-197" title="197">stateLoop a c [] (<span class="dt">Wait</span> t s k) <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-198" title="198">  wait t (stateLoop a c [] s) <span class="fu">$</span> \(<span class="dt">Event</span> t' a') <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-199" title="199">    stateLoop a' c [] (k (<span class="dt">Event</span> t' (a',c)))</a>
<a class="sourceLine" id="cb1-200" title="200"></a>
<a class="sourceLine" id="cb1-201" title="201"><span class="co">-- arrM lifts a monadic function into a Sim arrow.</span></a>
<a class="sourceLine" id="cb1-202" title="202"><span class="ot">arrM ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m b) <span class="ot">-&gt;</span> <span class="dt">Sim</span> m a b</a>
<a class="sourceLine" id="cb1-203" title="203">arrM f <span class="fu">=</span> sim <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-204" title="204">  b <span class="ot">&lt;-</span> f a</a>
<a class="sourceLine" id="cb1-205" title="205">  <span class="fu">return</span> (b,s)</a>
<a class="sourceLine" id="cb1-206" title="206">  <span class="kw">where</span> s <span class="fu">=</span> waitInput <span class="fu">$</span> \(<span class="dt">Event</span> t a) <span class="ot">-&gt;</span> lift <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-207" title="207">              b <span class="ot">&lt;-</span> f a</a>
<a class="sourceLine" id="cb1-208" title="208">              <span class="fu">return</span> (ready (<span class="dt">Event</span> t b) s)</a>
<a class="sourceLine" id="cb1-209" title="209"></a>
<a class="sourceLine" id="cb1-210" title="210"><span class="co">--printA prints all events that pass through</span></a>
<a class="sourceLine" id="cb1-211" title="211"><span class="ot">printA ::</span> <span class="dt">Show</span> b <span class="ot">=&gt;</span> [<span class="dt">Char</span>] <span class="ot">-&gt;</span> <span class="dt">Sim</span> <span class="dt">IO</span> b b</a>
<a class="sourceLine" id="cb1-212" title="212">printA name <span class="fu">=</span> sim <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-213" title="213">  message (<span class="fu">show</span> a<span class="fu">++</span><span class="st">&quot;@init&quot;</span>)</a>
<a class="sourceLine" id="cb1-214" title="214">  <span class="fu">return</span> (a,s)</a>
<a class="sourceLine" id="cb1-215" title="215">  <span class="kw">where</span> s <span class="fu">=</span> waitInput <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="dt">Lift</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-216" title="216">              message (<span class="fu">show</span> a)</a>
<a class="sourceLine" id="cb1-217" title="217">              <span class="fu">return</span> (ready a s)</a>
<a class="sourceLine" id="cb1-218" title="218">        message a <span class="fu">=</span> <span class="kw">if</span> <span class="fu">null</span> name <span class="kw">then</span> <span class="fu">putStrLn</span> a <span class="kw">else</span> <span class="fu">putStrLn</span> (name<span class="fu">++</span><span class="st">&quot;: &quot;</span><span class="fu">++</span>a)</a>
<a class="sourceLine" id="cb1-219" title="219"></a>
<a class="sourceLine" id="cb1-220" title="220"><span class="co">--delay1 d delays events by d, removing events at the same time</span></a>
<a class="sourceLine" id="cb1-221" title="221"><span class="ot">delay1 ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Time</span> <span class="ot">-&gt;</span> <span class="dt">Sim</span> m b b</a>
<a class="sourceLine" id="cb1-222" title="222">delay1 d <span class="fu">=</span> sim (\a <span class="ot">-&gt;</span> <span class="fu">return</span> (a,r))</a>
<a class="sourceLine" id="cb1-223" title="223">  <span class="kw">where</span> r <span class="fu">=</span> waitInput go</a>
<a class="sourceLine" id="cb1-224" title="224">        go (<span class="dt">Event</span> t a) <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-225" title="225">          wait (t<span class="fu">+</span>d) (ready (<span class="dt">Event</span> (t<span class="fu">+</span>d) a) r) <span class="fu">$</span> \(<span class="dt">Event</span> t' a') <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-226" title="226">            <span class="kw">if</span> t<span class="fu">==</span>t'</a>
<a class="sourceLine" id="cb1-227" title="227">              <span class="kw">then</span> go (<span class="dt">Event</span> t' a')</a>
<a class="sourceLine" id="cb1-228" title="228">              <span class="kw">else</span> ready (<span class="dt">Event</span> (t<span class="fu">+</span>d) a) (go (<span class="dt">Event</span> t' a'))</a>
<a class="sourceLine" id="cb1-229" title="229"></a>
<a class="sourceLine" id="cb1-230" title="230"><span class="ot">initially ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> b <span class="ot">-&gt;</span> <span class="dt">Sim</span> m t b <span class="ot">-&gt;</span> <span class="dt">Sim</span> m t b</a>
<a class="sourceLine" id="cb1-231" title="231">initially x (<span class="dt">Sim</span> f) <span class="fu">=</span> <span class="dt">Sim</span> <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="kw">do</span> (_,s) <span class="ot">&lt;-</span> f a</a>
<a class="sourceLine" id="cb1-232" title="232">                                     <span class="fu">return</span> (x,s)</a>
<a class="sourceLine" id="cb1-233" title="233"></a>
<a class="sourceLine" id="cb1-234" title="234"><span class="co">--nubA filters out events that repeat values</span></a>
<a class="sourceLine" id="cb1-235" title="235"><span class="ot">nubA ::</span> (<span class="dt">Eq</span> a, <span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Sim</span> m a a</a>
<a class="sourceLine" id="cb1-236" title="236">nubA <span class="fu">=</span> sim <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="fu">return</span> (a,go a)</a>
<a class="sourceLine" id="cb1-237" title="237">  <span class="kw">where</span> go a <span class="fu">=</span> waitInput <span class="fu">$</span> \(<span class="dt">Event</span> t a') <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-238" title="238">                 <span class="kw">if</span> a<span class="fu">==</span>a' <span class="kw">then</span> go a <span class="kw">else</span> ready (<span class="dt">Event</span> t a') (go a')</a>
<a class="sourceLine" id="cb1-239" title="239"></a>
<a class="sourceLine" id="cb1-240" title="240"><span class="co">-- cutoff t s stops a simulation after time t</span></a>
<a class="sourceLine" id="cb1-241" title="241"><span class="ot">cutoff ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Time</span> <span class="ot">-&gt;</span> <span class="dt">Sim</span> m t b <span class="ot">-&gt;</span> <span class="dt">Sim</span> m t b</a>
<a class="sourceLine" id="cb1-242" title="242">cutoff t (<span class="dt">Sim</span> f) <span class="fu">=</span> sim <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-243" title="243">                     (b,r) <span class="ot">&lt;-</span> f a</a>
<a class="sourceLine" id="cb1-244" title="244">                     <span class="fu">return</span> (b, cutoffState t r)</a>
<a class="sourceLine" id="cb1-245" title="245"></a>
<a class="sourceLine" id="cb1-246" title="246"><span class="ot">cutoffState ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span></a>
<a class="sourceLine" id="cb1-247" title="247">               <span class="dt">Time</span> <span class="ot">-&gt;</span> <span class="dt">State</span> m a a1 <span class="ot">-&gt;</span> <span class="dt">State</span> m a a1</a>
<a class="sourceLine" id="cb1-248" title="248">cutoffState t (<span class="dt">Ready</span> b s)</a>
<a class="sourceLine" id="cb1-249" title="249">  <span class="fu">|</span> time b<span class="fu">&lt;=</span>t <span class="fu">=</span> ready b (cutoffState t s)</a>
<a class="sourceLine" id="cb1-250" title="250">  <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> stop</a>
<a class="sourceLine" id="cb1-251" title="251">  <span class="kw">where</span> stop <span class="fu">=</span> waitInput (<span class="fu">const</span> stop)</a>
<a class="sourceLine" id="cb1-252" title="252">cutoffState t (<span class="dt">Lift</span> m) <span class="fu">=</span> lift (liftM (cutoffState t) m)</a>
<a class="sourceLine" id="cb1-253" title="253">cutoffState t (<span class="dt">Wait</span> t' s k)</a>
<a class="sourceLine" id="cb1-254" title="254">  <span class="fu">|</span> t'<span class="fu">&lt;=</span>t     <span class="fu">=</span> wait t' (cutoffState t s) (cutoffState t<span class="fu">.</span>k)</a>
<a class="sourceLine" id="cb1-255" title="255">  <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> wait infinity <span class="fu">undefined</span> (cutoffState t<span class="fu">.</span>k)</a>
<a class="sourceLine" id="cb1-256" title="256"></a>
<a class="sourceLine" id="cb1-257" title="257"><span class="co">-- Experiments with arrow notation</span></a>
<a class="sourceLine" id="cb1-258" title="258"></a>
<a class="sourceLine" id="cb1-259" title="259"><span class="ot">nor ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Sim</span> m (<span class="dt">Bool</span>,<span class="dt">Bool</span>) <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-260" title="260">nor <span class="fu">=</span> proc (a,b) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-261" title="261">        (a',b') <span class="ot">&lt;-</span> delay1 <span class="fl">0.1</span> <span class="fu">-&lt;</span> (a,b)</a>
<a class="sourceLine" id="cb1-262" title="262">        returnA <span class="fu">-&lt;</span> <span class="fu">not</span> (a'<span class="fu">||</span>b')</a>
<a class="sourceLine" id="cb1-263" title="263"></a>
<a class="sourceLine" id="cb1-264" title="264"><span class="ot">afix ::</span> (<span class="dt">MonadFix</span> m, <span class="dt">Eq</span> b) <span class="ot">=&gt;</span> <span class="dt">Sim</span> m (a,b) b <span class="ot">-&gt;</span> <span class="dt">Sim</span> m a b</a>
<a class="sourceLine" id="cb1-265" title="265">afix f <span class="fu">=</span> loop (f <span class="fu">&gt;&gt;&gt;</span> nubA <span class="fu">&gt;&gt;&gt;</span> arr <span class="fu">id</span> <span class="fu">&amp;&amp;&amp;</span> arr <span class="fu">id</span>) <span class="fu">&gt;&gt;&gt;</span> nubA</a>
<a class="sourceLine" id="cb1-266" title="266"></a>
<a class="sourceLine" id="cb1-267" title="267"><span class="ot">flipflop ::</span> <span class="dt">MonadFix</span> m <span class="ot">=&gt;</span> <span class="dt">Sim</span> m (<span class="dt">Bool</span>,<span class="dt">Bool</span>) (<span class="dt">Bool</span>,<span class="dt">Bool</span>)</a>
<a class="sourceLine" id="cb1-268" title="268">flipflop <span class="fu">=</span> proc (reset,set) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-269" title="269">                (<span class="fu">|</span>afix (\ <span class="fu">~</span>(x,y)<span class="ot">-&gt;</span><span class="kw">do</span></a>
<a class="sourceLine" id="cb1-270" title="270">                                x' <span class="ot">&lt;-</span> initially <span class="dt">False</span> nor <span class="fu">-&lt;</span> (reset,y)</a>
<a class="sourceLine" id="cb1-271" title="271">                                y' <span class="ot">&lt;-</span> initially <span class="dt">True</span> nor <span class="fu">-&lt;</span> (set,x)</a>
<a class="sourceLine" id="cb1-272" title="272">                                returnA <span class="fu">-&lt;</span> (x',y'))<span class="fu">|</span>)</a>
<a class="sourceLine" id="cb1-273" title="273"></a>
<a class="sourceLine" id="cb1-274" title="274"><span class="ot">oscillator ::</span> <span class="dt">MonadFix</span> m <span class="ot">=&gt;</span> <span class="dt">Sim</span> m <span class="dt">Bool</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-275" title="275">oscillator <span class="fu">=</span> proc enable <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-276" title="276">  (<span class="fu">|</span>afix (\x <span class="ot">-&gt;</span> nor <span class="fu">-&lt;</span> (enable,x))<span class="fu">|</span>)</a>
<a class="sourceLine" id="cb1-277" title="277"></a>
<a class="sourceLine" id="cb1-278" title="278"></a>
<a class="sourceLine" id="cb1-279" title="279"><span class="co">-- probe counts the transitions on a channel</span></a>
<a class="sourceLine" id="cb1-280" title="280"><span class="co">-- this is useful for estimating power consumption</span></a>
<a class="sourceLine" id="cb1-281" title="281"></a>
<a class="sourceLine" id="cb1-282" title="282"><span class="ot">probe ::</span> <span class="dt">Metric</span> a <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> (<span class="dt">Sim</span> <span class="dt">IO</span> a a <span class="ot">-&gt;</span> <span class="dt">IO</span> b) <span class="ot">-&gt;</span> <span class="dt">IO</span> b</a>
<a class="sourceLine" id="cb1-283" title="283">probe s k <span class="fu">=</span> <span class="kw">do</span> r <span class="ot">&lt;-</span> newIORef <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-284" title="284">               ans <span class="ot">&lt;-</span> k (probeArr r)</a>
<a class="sourceLine" id="cb1-285" title="285">               n <span class="ot">&lt;-</span> readIORef r</a>
<a class="sourceLine" id="cb1-286" title="286">               <span class="fu">putStrLn</span> (s<span class="fu">++</span><span class="st">&quot;: &quot;</span><span class="fu">++show</span> n<span class="fu">++</span><span class="st">&quot; transitions&quot;</span>)</a>
<a class="sourceLine" id="cb1-287" title="287">               <span class="fu">return</span> ans</a>
<a class="sourceLine" id="cb1-288" title="288">  <span class="kw">where</span> probeArr r <span class="fu">=</span> sim <span class="fu">$</span> \a <span class="ot">-&gt;</span> <span class="fu">return</span> (a, stateProbe r a)</a>
<a class="sourceLine" id="cb1-289" title="289">        stateProbe r a <span class="fu">=</span> waitInput <span class="fu">$</span> \(<span class="dt">Event</span> t b) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-290" title="290">                             lift <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-291" title="291">                               modifyIORef r (<span class="fu">+</span>distance a b)</a>
<a class="sourceLine" id="cb1-292" title="292">                               <span class="fu">return</span> (ready (<span class="dt">Event</span> t b) (stateProbe r b))</a>
<a class="sourceLine" id="cb1-293" title="293"></a>
<a class="sourceLine" id="cb1-294" title="294"><span class="kw">class</span> <span class="dt">Metric</span> a <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-295" title="295"><span class="ot">  distance ::</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb1-296" title="296"><span class="ot">  bound ::</span> a <span class="ot">-&gt;</span> <span class="dt">Double</span>  <span class="co">-- the distance between any two points is below bound</span></a>
<a class="sourceLine" id="cb1-297" title="297">                        <span class="co">-- bound does not evaluate its argument</span></a>
<a class="sourceLine" id="cb1-298" title="298"></a>
<a class="sourceLine" id="cb1-299" title="299"><span class="kw">instance</span> <span class="dt">Metric</span> <span class="dt">Bool</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-300" title="300">  distance a b <span class="fu">=</span> <span class="kw">if</span> a<span class="fu">==</span>b <span class="kw">then</span> <span class="dv">0</span> <span class="kw">else</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb1-301" title="301">  bound _ <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb1-302" title="302"></a>
<a class="sourceLine" id="cb1-303" title="303"><span class="kw">instance</span> (<span class="dt">Metric</span> a, <span class="dt">Metric</span> b) <span class="ot">=&gt;</span> <span class="dt">Metric</span> (a,b) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-304" title="304">  distance (a,b) (c,d) <span class="fu">=</span> distance a c<span class="fu">+</span>distance b d</a>
<a class="sourceLine" id="cb1-305" title="305">  bound <span class="fu">~</span>(a,b)<span class="fu">=</span> bound a <span class="fu">+</span> bound b</a>
<a class="sourceLine" id="cb1-306" title="306"></a>
<a class="sourceLine" id="cb1-307" title="307"><span class="kw">instance</span> (<span class="dt">Metric</span> a, <span class="dt">Metric</span> b) <span class="ot">=&gt;</span> <span class="dt">Metric</span> (<span class="dt">Either</span> a b) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-308" title="308">  distance (<span class="dt">Left</span> a) (<span class="dt">Left</span> a') <span class="fu">=</span> distance a a'</a>
<a class="sourceLine" id="cb1-309" title="309">  distance (<span class="dt">Right</span> b) (<span class="dt">Right</span> b') <span class="fu">=</span> distance b b'</a>
<a class="sourceLine" id="cb1-310" title="310">  distance x _ <span class="fu">=</span> <span class="dv">1</span> <span class="fu">+</span> (bound a <span class="ot">`max`</span> bound b)</a>
<a class="sourceLine" id="cb1-311" title="311">    <span class="kw">where</span> <span class="dt">Left</span> a <span class="fu">=</span> x</a>
<a class="sourceLine" id="cb1-312" title="312">          <span class="dt">Right</span> b <span class="fu">=</span> x</a>
<a class="sourceLine" id="cb1-313" title="313">  bound x <span class="fu">=</span> <span class="dv">1</span> <span class="fu">+</span> (bound l <span class="ot">`max`</span> bound r)</a>
<a class="sourceLine" id="cb1-314" title="314">    <span class="kw">where</span> <span class="dt">Left</span> l <span class="fu">=</span> x</a>
<a class="sourceLine" id="cb1-315" title="315">          <span class="dt">Right</span> r <span class="fu">=</span> x</a>
<a class="sourceLine" id="cb1-316" title="316"></a>
<a class="sourceLine" id="cb1-317" title="317"><span class="kw">instance</span> <span class="dt">Metric</span> a <span class="ot">=&gt;</span> <span class="dt">Metric</span> [a] <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-318" title="318">  distance [] [] <span class="fu">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-319" title="319">  distance (x<span class="fu">:</span>xs) (y<span class="fu">:</span>ys) <span class="fu">=</span> distance x y <span class="fu">+</span> distance xs ys</a>
<a class="sourceLine" id="cb1-320" title="320">  distance [] (y<span class="fu">:</span>ys) <span class="fu">=</span> (bound y<span class="fu">+</span><span class="dv">1</span>)<span class="fu">*</span>(<span class="fu">fromInteger</span> (<span class="fu">toInteger</span> (<span class="fu">length</span> ys))<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-321" title="321">  distance xs [] <span class="fu">=</span> distance [] xs</a>
<a class="sourceLine" id="cb1-322" title="322">  bound _ <span class="fu">=</span> infinity</a></code></pre></div>
    </div>

    <div id="footer">
      <a href="http://jaspervdj.be/hakyll/index.html" id="hakyllLink">Powered by Hakyll</a>

      <span id="dates">
        
        
      </span>
    </div>
  </body>
</html>
