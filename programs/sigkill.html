<!DOCTYPE html>
<html lang="en">
  <head>
    <title>sigkill</title>
    <link rel="stylesheet" href="../css/default.css" type="text/css" media="screen" title="default">
    <link rel="stylesheet" href="../css/syntax.css" type="text/css">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description" content="Troels Henriksen's piece of the web.  Mostly about programming.">
    <meta name="keywords" content="Braintwist, Brainfuck, Lisp, Common Lisp Troels Henriksen, Brainfork, Esoteric programming language, programming, Haskell, functional programming, Futhark">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <div id="header">
      <div class="superHeader">

        <div class="right">
          <span class="doNotDisplay">Related sites:</span>
          <ul>
            <li><a href="https://github.com/Athas/sigkill.dk">github</a></li>
            
            <li><a href=".././programs/sigkill.lhs">source</a></li>
            
          </ul>
        </div>

      </div>

      <div class="midHeader">
        <h1 class="headerTitle"><a href="../">SIGKILL <span id="headerSubTitle">-9</span></a></h1>
      </div>

      <div class="subHeader">
        <ul class="menu0"><li><a href="../blog/">blog/</a></li><li><a href="../hacks/">hacks/</a></li><li><a href="../links.html">links</a></li><li><a href="../me/">me/</a></li><li><a href="../programs/" class="thisPage">programs/</a></li><li><a href="../projects/">projects/</a></li><li><a href="../writings/">writings/</a></li></ul><ul class="menu1"><li><a href="../programs/arrows/">arrows/</a></li><li><a href="../programs/sigkill.html" class="thisPage">sigkill</a></li><li><a href="../programs/stepping.html">stepping</a></li></ul>
      </div>
    </div>

    <div id="content">
      <h1 id="the-sigkill.dk-generator"><a href="#the-sigkill.dk-generator" id="the-sigkill.dk-generator-link" class="titlelink" title="the-sigkill.dk-generator">The Sigkill.dk generator</a></h1>
<p>This is the Hakyll program for generating sigkill.dk (see my <a href="../writings/guides/hakyll.html">Hakyll tutorial</a>). Look at <a href="https://github.com/Athas/sigkill.dk">this Git repository</a> for the data files as well. The most defining trait of the site is the tree menu at the top, which contains every content page on the site. Apart from that, I also do a lot of small hacks to generate various bits of the site. There is also a simple blog system, with one file per post.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">module</span> <span class="dt">Main</span>(main) <span class="kw">where</span></a></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">import</span> <span class="dt">Control.Arrow</span> (first, (&amp;&amp;&amp;))</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">import</span> <span class="dt">Control.Monad</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">import</span> <span class="dt">Data.Char</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">import</span> <span class="dt">Data.List</span> <span class="kw">hiding</span> (group)</a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw">import</span> <span class="dt">Data.Ord</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="kw">import</span> <span class="dt">Data.Maybe</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="kw">import</span> <span class="dt">Data.Monoid</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="kw">import</span> <span class="dt">System.FilePath</span></a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">import</span> <span class="dt">Text.Blaze.Internal</span> (preEscapedString)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">import</span> <span class="dt">Text.Blaze.Html5</span> ((!))</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.Blaze.Html5</span> <span class="kw">as</span> <span class="dt">H</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.Blaze.Html5.Attributes</span> <span class="kw">as</span> <span class="dt">A</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw">import</span> <span class="dt">Text.Blaze.Html.Renderer.String</span> (renderHtml)</a>
<a class="sourceLine" id="cb3-6" title="6"><span class="kw">import</span>           <span class="dt">Text.Pandoc</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="kw">import</span>           <span class="dt">Text.Pandoc.Walk</span></a></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">import</span> <span class="dt">Hakyll</span></a></code></pre></div>
<h2 id="hierarchical-menu."><a href="#hierarchical-menu." id="hierarchical-menu.-link" class="titlelink" title="hierarchical-menu.">Hierarchical menu.</a></h2>
<p>We are going to define a data type and associated helper functions for generating a menu. Conceptually, the site is a directory tree, with a page being a leaf of the tree. The menu for a given page will illustrate the path taken from the root to the page, namely which intermediary directories were entered.</p>
<p>A level (or “line”, if you look at its actual visual appearance) of the menu consists of two lists: the elements preceding and succeeding the <em>focused element</em>. The focused element itself is the first element of the <code>aftItems</code> list. This definition ensures that we have at most a single focused element per menu level. Each element is a pair consisting of an URL and a name.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">data</span> <span class="dt">MenuLevel</span> <span class="fu">=</span> <span class="dt">MenuLevel</span> {<span class="ot"> prevItems ::</span> [(<span class="dt">FilePath</span>,<span class="dt">String</span>)]</a>
<a class="sourceLine" id="cb5-2" title="2">                           ,<span class="ot"> aftItems  ::</span> [(<span class="dt">FilePath</span>,<span class="dt">String</span>)]</a>
<a class="sourceLine" id="cb5-3" title="3">                           }</a>
<a class="sourceLine" id="cb5-4" title="4"></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="ot">allItems ::</span> <span class="dt">MenuLevel</span> <span class="ot">-&gt;</span> [(<span class="dt">FilePath</span>, <span class="dt">String</span>)]</a>
<a class="sourceLine" id="cb5-6" title="6">allItems l <span class="fu">=</span> prevItems l <span class="fu">++</span> aftItems l</a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="ot">emptyMenuLevel ::</span> <span class="dt">MenuLevel</span></a>
<a class="sourceLine" id="cb6-2" title="2">emptyMenuLevel <span class="fu">=</span> <span class="dt">MenuLevel</span> [] []</a></code></pre></div>
<p>First, let us define a function for inserting an element into a sorted list, returning the original list if the element is already there.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="ot">insertUniq ::</span> <span class="dt">Ord</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [a]</a>
<a class="sourceLine" id="cb7-2" title="2">insertUniq x xs <span class="fu">|</span> x <span class="ot">`elem`</span> xs <span class="fu">=</span> xs</a>
<a class="sourceLine" id="cb7-3" title="3">                <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> insert x xs</a></code></pre></div>
<p>We can use this function to insert a non-focused element into a <code>MenuLevel</code>. We take care to put the new element in its proper sorted position relative to the focused element, if any.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="ot">insertItem ::</span> <span class="dt">MenuLevel</span> <span class="ot">-&gt;</span> (<span class="dt">FilePath</span>, <span class="dt">String</span>) <span class="ot">-&gt;</span> <span class="dt">MenuLevel</span></a>
<a class="sourceLine" id="cb8-2" title="2">insertItem l v <span class="fu">=</span> <span class="kw">case</span> aftItems l <span class="kw">of</span></a>
<a class="sourceLine" id="cb8-3" title="3">                   []     <span class="ot">-&gt;</span> atPrev</a>
<a class="sourceLine" id="cb8-4" title="4">                   (x<span class="fu">:</span>xs) <span class="fu">|</span> v <span class="fu">&lt;</span> x     <span class="ot">-&gt;</span> atPrev</a>
<a class="sourceLine" id="cb8-5" title="5">                          <span class="fu">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> l { aftItems <span class="fu">=</span> x<span class="fu">:</span>insertUniq v xs }</a>
<a class="sourceLine" id="cb8-6" title="6">  <span class="kw">where</span> atPrev <span class="fu">=</span> l { prevItems <span class="fu">=</span> insertUniq v (prevItems l) }</a></code></pre></div>
<p>When inserting a focused element, we have to split the elements into those that go before and those that come after the focused element.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="ot">insertFocused ::</span> <span class="dt">MenuLevel</span> <span class="ot">-&gt;</span> (<span class="dt">FilePath</span>, <span class="dt">String</span>) <span class="ot">-&gt;</span> <span class="dt">MenuLevel</span></a>
<a class="sourceLine" id="cb9-2" title="2">insertFocused l v <span class="fu">=</span> <span class="dt">MenuLevel</span> bef (v<span class="fu">:</span>aft)</a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="kw">where</span> (bef, aft) <span class="fu">=</span> partition (<span class="fu">&lt;</span>v) (delete v <span class="fu">$</span> allItems l)</a></code></pre></div>
<p>Finally, a menu is just a list of menu levels.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">newtype</span> <span class="dt">Menu</span> <span class="fu">=</span> <span class="dt">Menu</span> {<span class="ot"> menuLevels ::</span> [<span class="dt">MenuLevel</span>] }</a>
<a class="sourceLine" id="cb10-2" title="2"></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="ot">emptyMenu ::</span> <span class="dt">Menu</span></a>
<a class="sourceLine" id="cb10-4" title="4">emptyMenu <span class="fu">=</span> <span class="dt">Menu</span> []</a></code></pre></div>
<p>I am using the <a href="http://jaspervdj.be/blaze/">BlazeHTML</a> library for HTML generation, so the result of rendering a menu is an <code>H.Html</code> value. The rendering will consist of one HTML <code>&lt;ul&gt;</code> block per menu level, each with the CSS class <code>menuN</code>, where <code>N</code> is the number of the level.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="ot">showMenu ::</span> <span class="dt">Menu</span> <span class="ot">-&gt;</span> <span class="dt">H.Html</span></a>
<a class="sourceLine" id="cb11-2" title="2">showMenu <span class="fu">=</span> zipWithM_ showMenuLevel [<span class="dv">0</span><span class="fu">..</span>] <span class="fu">.</span> menuLevels</a></code></pre></div>
<p>The focus element is tagged with the CSS class <code>thisPage</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1"><span class="ot">showMenuLevel ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">MenuLevel</span> <span class="ot">-&gt;</span> <span class="dt">H.Html</span></a>
<a class="sourceLine" id="cb12-2" title="2">showMenuLevel d m <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-3" title="3">  H.ul (<span class="fu">mapM_</span> H.li elems) <span class="fu">!</span> A.class_ (H.toValue <span class="fu">$</span> <span class="st">&quot;menu&quot;</span> <span class="fu">++</span> <span class="fu">show</span> d)</a>
<a class="sourceLine" id="cb12-4" title="4">  <span class="kw">where</span> showElem (p,k) <span class="fu">=</span> H.a (H.toHtml k) <span class="fu">!</span> A.href (H.toValue p)</a>
<a class="sourceLine" id="cb12-5" title="5">        showFocusElem (p,k) <span class="fu">=</span> showElem (p,k) <span class="fu">!</span> A.class_ <span class="st">&quot;thisPage&quot;</span></a>
<a class="sourceLine" id="cb12-6" title="6">        elems <span class="fu">=</span> <span class="fu">map</span> showElem (prevItems m) <span class="fu">++</span></a>
<a class="sourceLine" id="cb12-7" title="7">                <span class="kw">case</span> aftItems m <span class="kw">of</span> []     <span class="ot">-&gt;</span> []</a>
<a class="sourceLine" id="cb12-8" title="8">                                   (l<span class="fu">:</span>ls) <span class="ot">-&gt;</span> showFocusElem l <span class="fu">:</span></a>
<a class="sourceLine" id="cb12-9" title="9">                                             <span class="fu">map</span> showElem ls</a></code></pre></div>
<h2 id="building-the-menu"><a href="#building-the-menu" id="building-the-menu-link" class="titlelink" title="building-the-menu">Building the menu</a></h2>
<p>Recall that the directory structure of the site is a tree. To construct a menu, we are given the current node (page) and a list of all possible nodes of the tree (all pages on the site), and we then construct the minimum tree that contains all nodes on the path from the root to the current node, as well as all siblings of those nodes. In file system terms, we show the files contained in each directory traversed from the root to the current page (as well as any children of the current page, if it is a directory).</p>
<p>To begin, we define a function that given the current path, decomposes some other path into the part that should be visible. For example:</p>
<pre><code>relevant &quot;foo/bar/baz&quot; &quot;foo/bar/quux&quot; = [&quot;foo/&quot;,&quot;bar/&quot;,&quot;quux&quot;]
relevant &quot;foo/bar/baz&quot; &quot;foo/bar/quux/&quot; = [&quot;foo/&quot;,&quot;bar/&quot;,&quot;quux/&quot;]
relevant &quot;foo/bar/baz&quot; &quot;foo/bar/quux/zog&quot; = [&quot;foo/&quot;,&quot;bar/&quot;,&quot;quux/&quot;]
relevant &quot;foo/bar/baz&quot; &quot;quux/zog&quot; = [&quot;quux/&quot;]</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1"><span class="ot">relevant ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>]</a>
<a class="sourceLine" id="cb14-2" title="2">relevant this other <span class="fu">=</span> relevant' (splitPath this) (splitPath other)</a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="kw">where</span> relevant' (x<span class="fu">:</span>xs) (y<span class="fu">:</span>ys) <span class="fu">=</span> y <span class="fu">:</span> <span class="kw">if</span> x <span class="fu">==</span> y <span class="kw">then</span> relevant' xs ys <span class="kw">else</span> []</a>
<a class="sourceLine" id="cb14-4" title="4">        relevant' [] (y<span class="fu">:</span>_) <span class="fu">=</span> [y]</a>
<a class="sourceLine" id="cb14-5" title="5">        relevant' _ _ <span class="fu">=</span> []</a></code></pre></div>
<p>To construct a full menu given the current path and a list of all paths, we repeatedly extend it by a single path. Recall that menu elements are pairs of names and paths - we generate those names by taking the file name and dropping the extension of the path, also dropping any trailing “index.html” from paths.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1"><span class="ot">buildMenu ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">Menu</span></a>
<a class="sourceLine" id="cb15-2" title="2">buildMenu this <span class="fu">=</span> <span class="fu">foldl</span> (extendMenu this) emptyMenu</a>
<a class="sourceLine" id="cb15-3" title="3">                 <span class="fu">.</span> <span class="fu">map</span> (first dropIndex <span class="fu">.</span> (<span class="fu">id</span> <span class="fu">&amp;&amp;&amp;</span> dropExtension <span class="fu">.</span> takeFileName))</a>
<a class="sourceLine" id="cb15-4" title="4"></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="ot">dropIndex ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span></a>
<a class="sourceLine" id="cb15-6" title="6">dropIndex p <span class="fu">|</span> takeBaseName p <span class="fu">==</span> <span class="st">&quot;index&quot;</span> <span class="fu">=</span> dropFileName p</a>
<a class="sourceLine" id="cb15-7" title="7">            <span class="fu">|</span> <span class="fu">otherwise</span>                 <span class="fu">=</span> p</a></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" title="1"><span class="ot">extendMenu ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Menu</span> <span class="ot">-&gt;</span> (<span class="dt">FilePath</span>, <span class="dt">String</span>) <span class="ot">-&gt;</span> <span class="dt">Menu</span></a>
<a class="sourceLine" id="cb16-2" title="2">extendMenu this m (path, name) <span class="fu">=</span></a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="kw">if</span> path' <span class="ot">`elem`</span> [<span class="st">&quot;./&quot;</span>, <span class="st">&quot;/&quot;</span>, <span class="st">&quot;&quot;</span>] <span class="kw">then</span> m <span class="kw">else</span></a>
<a class="sourceLine" id="cb16-4" title="4">    <span class="dt">Menu</span> <span class="fu">$</span> add (menuLevels m) (relevant this' path') <span class="st">&quot;/&quot;</span></a>
<a class="sourceLine" id="cb16-5" title="5">  <span class="kw">where</span> add ls [] _ <span class="fu">=</span> ls</a>
<a class="sourceLine" id="cb16-6" title="6">        add ls (x<span class="fu">:</span>xs) p</a>
<a class="sourceLine" id="cb16-7" title="7">          <span class="fu">|</span> x <span class="ot">`elem`</span> focused <span class="fu">=</span> insertFocused l (p<span class="fu">++</span>x,name') <span class="fu">:</span> add ls' xs (p<span class="fu">++</span>x)</a>
<a class="sourceLine" id="cb16-8" title="8">          <span class="fu">|</span> <span class="fu">otherwise</span>        <span class="fu">=</span> insertItem l (p<span class="fu">++</span>x,name') <span class="fu">:</span> add ls' xs (p<span class="fu">++</span>x)</a>
<a class="sourceLine" id="cb16-9" title="9">          <span class="kw">where</span> (l,ls') <span class="fu">=</span> <span class="kw">case</span> ls <span class="kw">of</span> []  <span class="ot">-&gt;</span> (emptyMenuLevel, [])</a>
<a class="sourceLine" id="cb16-10" title="10">                                     k<span class="fu">:</span>ks <span class="ot">-&gt;</span> (k,ks)</a>
<a class="sourceLine" id="cb16-11" title="11">                name' <span class="fu">=</span> <span class="kw">if</span> hasTrailingPathSeparator x <span class="kw">then</span> x <span class="kw">else</span> name</a>
<a class="sourceLine" id="cb16-12" title="12">        focused <span class="fu">=</span> splitPath this'</a>
<a class="sourceLine" id="cb16-13" title="13">        path' <span class="fu">=</span> normalise path</a>
<a class="sourceLine" id="cb16-14" title="14">        this' <span class="fu">=</span> normalise this</a></code></pre></div>
<p>For convenience, we define a Hakyll rule that adds anything currently matched to the menu. To do this, we first need two convenience functions. The first checks whether the identifier of the current compilation is defined with some other version (recall that a version is identified by a <code>Maybe String</code>, not just a <code>String</code>), and if so, returns the route of that identifier.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" title="1"><span class="ot">routeWithVersion ::</span> <span class="dt">Maybe</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Compiler</span> (<span class="dt">Maybe</span> <span class="dt">FilePath</span>)</a>
<a class="sourceLine" id="cb17-2" title="2">routeWithVersion v <span class="fu">=</span> getRoute <span class="fu">=&lt;&lt;</span> setVersion v <span class="fu">&lt;$&gt;</span> getUnderlying</a></code></pre></div>
<p>The second extracts the route for the current identifier with no version. As a matter of convenience, we return an empty path if the identifier has no associated route. This should never occur in practice.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" title="1"><span class="ot">normalRoute ::</span> <span class="dt">Compiler</span> <span class="dt">FilePath</span></a>
<a class="sourceLine" id="cb18-2" title="2">normalRoute <span class="fu">=</span> fromMaybe <span class="st">&quot;&quot;</span> <span class="fu">&lt;$&gt;</span> routeWithVersion <span class="dt">Nothing</span></a></code></pre></div>
<p>The <code>&quot;menu&quot;</code> version will contain an identifier for every page that should show up in the site menu, with the compiler for each identifier generating a pathname.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" title="1"><span class="ot">addToMenu ::</span> <span class="dt">Rules</span> ()</a>
<a class="sourceLine" id="cb19-2" title="2">addToMenu <span class="fu">=</span> version <span class="st">&quot;menu&quot;</span> <span class="fu">$</span> compile <span class="fu">$</span> makeItem <span class="fu">=&lt;&lt;</span> normalRoute</a></code></pre></div>
<p>To generate the menu for a given page, we use <code>loadAll</code> to obtain a list of everything with the version “menu” (the pathnames) and use it to build the menu, which is immediately rendered to HTML. If a compiler has been defined for these identifiers that creates anything but a <code>FilePath</code>, Hakyll will signal a run-time type error.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" title="1"><span class="ot">getMenu ::</span> <span class="dt">Compiler</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb20-2" title="2">getMenu <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb20-3" title="3">  menu <span class="ot">&lt;-</span> <span class="fu">map</span> itemBody <span class="fu">&lt;$&gt;</span> loadAll (fromVersion <span class="fu">$</span> <span class="dt">Just</span> <span class="st">&quot;menu&quot;</span>)</a>
<a class="sourceLine" id="cb20-4" title="4">  myRoute <span class="ot">&lt;-</span> getRoute <span class="fu">=&lt;&lt;</span> getUnderlying</a>
<a class="sourceLine" id="cb20-5" title="5">  <span class="fu">return</span> <span class="fu">$</span> renderHtml <span class="fu">$</span> showMenu <span class="fu">$</span> <span class="kw">case</span> myRoute <span class="kw">of</span></a>
<a class="sourceLine" id="cb20-6" title="6">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> buildMenu <span class="st">&quot;&quot;</span> menu</a>
<a class="sourceLine" id="cb20-7" title="7">    <span class="dt">Just</span> me <span class="ot">-&gt;</span> buildMenu me menu</a></code></pre></div>
<h2 id="extracting-descriptive-texts-from-small-programs."><a href="#extracting-descriptive-texts-from-small-programs." id="extracting-descriptive-texts-from-small-programs.-link" class="titlelink" title="extracting-descriptive-texts-from-small-programs.">Extracting descriptive texts from small programs.</a></h2>
<p>I have a number of small programs and scripts of my site, and I want to automatically generate a list and description for each of them. Each program starts with a descriptive comment containing Markdown markup, so the challenge becomes extracting that comment. I define functions for extracting the leading comment from shell, C and Haskell, respectively.</p>
<p>For shell scripts, we take all leading lines that have a comment character in the first column, excepting the hashbang (<code>#!</code>). This also works for many other languages.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" title="1"><span class="ot">shDocstring ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb21-2" title="2">shDocstring <span class="fu">=</span> <span class="fu">unlines</span></a>
<a class="sourceLine" id="cb21-3" title="3">              <span class="fu">.</span> <span class="fu">map</span> (<span class="fu">drop</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb21-4" title="4">              <span class="fu">.</span> <span class="fu">takeWhile</span> (<span class="st">&quot;#&quot;</span> <span class="ot">`isPrefixOf`</span>)</a>
<a class="sourceLine" id="cb21-5" title="5">              <span class="fu">.</span> <span class="fu">dropWhile</span> (<span class="fu">all</span> (<span class="ot">`elem`</span> [<span class="ch">'#'</span>, <span class="ch">' '</span>]))</a>
<a class="sourceLine" id="cb21-6" title="6">              <span class="fu">.</span> <span class="fu">dropWhile</span> (<span class="st">&quot;#!&quot;</span> <span class="ot">`isPrefixOf`</span>)</a>
<a class="sourceLine" id="cb21-7" title="7">              <span class="fu">.</span> <span class="fu">lines</span></a></code></pre></div>
<p>For C, we extract the first multi-line comment. At this point we should probably have used a regular expression library.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" title="1"><span class="ot">cDocstring ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb22-2" title="2">cDocstring <span class="fu">=</span> <span class="fu">unlines</span></a>
<a class="sourceLine" id="cb22-3" title="3">             <span class="fu">.</span> <span class="fu">map</span> (<span class="fu">dropWhile</span> (<span class="fu">==</span><span class="ch">' '</span>)</a>
<a class="sourceLine" id="cb22-4" title="4">                    <span class="fu">.</span> <span class="fu">dropWhile</span> (<span class="fu">==</span><span class="ch">'*'</span>)</a>
<a class="sourceLine" id="cb22-5" title="5">                    <span class="fu">.</span> <span class="fu">dropWhile</span> (<span class="fu">==</span><span class="ch">' '</span>))</a>
<a class="sourceLine" id="cb22-6" title="6">             <span class="fu">.</span> <span class="fu">maybe</span> [] <span class="fu">lines</span></a>
<a class="sourceLine" id="cb22-7" title="7">             <span class="fu">.</span> (<span class="fu">return</span> <span class="fu">.</span> <span class="fu">reverse</span> <span class="fu">.</span> cut <span class="fu">.</span> <span class="fu">reverse</span></a>
<a class="sourceLine" id="cb22-8" title="8">                <span class="fu">&lt;=&lt;</span> find (<span class="st">&quot;*/&quot;</span> <span class="ot">`isSuffixOf`</span>) <span class="fu">.</span> inits</a>
<a class="sourceLine" id="cb22-9" title="9">                <span class="fu">&lt;=&lt;</span> <span class="fu">return</span> <span class="fu">.</span> cut</a>
<a class="sourceLine" id="cb22-10" title="10">                <span class="fu">&lt;=&lt;</span> find (<span class="st">&quot;/*&quot;</span> <span class="ot">`isPrefixOf`</span>) <span class="fu">.</span> tails)</a>
<a class="sourceLine" id="cb22-11" title="11">  <span class="kw">where</span> cut s <span class="fu">|</span> <span class="st">&quot;/*&quot;</span> <span class="ot">`isPrefixOf`</span> s <span class="fu">=</span> cut <span class="fu">$</span> <span class="fu">drop</span> <span class="dv">2</span> s</a>
<a class="sourceLine" id="cb22-12" title="12">              <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> <span class="fu">dropWhile</span> <span class="fu">isSpace</span> s</a></code></pre></div>
<p>Haskell is processed much like shell script: We extract the leading line comments.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" title="1"><span class="ot">hsDocstring ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb23-2" title="2">hsDocstring <span class="fu">=</span> <span class="fu">unlines</span></a>
<a class="sourceLine" id="cb23-3" title="3">              <span class="fu">.</span> <span class="fu">map</span> (<span class="fu">drop</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb23-4" title="4">              <span class="fu">.</span> <span class="fu">takeWhile</span> (<span class="st">&quot;--&quot;</span> <span class="ot">`isPrefixOf`</span>)</a>
<a class="sourceLine" id="cb23-5" title="5">              <span class="fu">.</span> <span class="fu">dropWhile</span> (<span class="st">&quot;#!&quot;</span> <span class="ot">`isPrefixOf`</span>)</a>
<a class="sourceLine" id="cb23-6" title="6">              <span class="fu">.</span> <span class="fu">lines</span></a></code></pre></div>
<p>A <em>hack compiler</em> produces, from a script file, a <code>String</code> containing its name and docstring in HTML format, based on an HTML template. The docstring is assumed to be in Markdown format, so we pass the entire thing through a Markdown-to-HTML compiler. Unfortunately, it seems that <code>renderPandoc</code> inspects the pathname given <code>Item</code> to figure out the input format, so we force Markdown interpretation by pretending the docstring is in a file of name <code>&quot;.md&quot;</code>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" title="1"><span class="ot">hackCompiler ::</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb24-2" title="2">hackCompiler <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb24-3" title="3">  ext <span class="ot">&lt;-</span> getUnderlyingExtension</a>
<a class="sourceLine" id="cb24-4" title="4">  src <span class="ot">&lt;-</span> itemBody <span class="fu">&lt;$&gt;</span> getResourceString</a>
<a class="sourceLine" id="cb24-5" title="5">  desc <span class="ot">&lt;-</span> <span class="fu">return</span> <span class="fu">$</span> <span class="kw">case</span> ext <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-6" title="6">                    <span class="st">&quot;.c&quot;</span>  <span class="ot">-&gt;</span> cDocstring src</a>
<a class="sourceLine" id="cb24-7" title="7">                    <span class="st">&quot;.hs&quot;</span> <span class="ot">-&gt;</span> hsDocstring src</a>
<a class="sourceLine" id="cb24-8" title="8">                    _     <span class="ot">-&gt;</span> shDocstring src</a>
<a class="sourceLine" id="cb24-9" title="9">  dest <span class="ot">&lt;-</span> normalRoute</a>
<a class="sourceLine" id="cb24-10" title="10">  desc' <span class="ot">&lt;-</span> renderPandoc <span class="fu">$</span> <span class="dt">Item</span> <span class="st">&quot;.md&quot;</span> desc</a>
<a class="sourceLine" id="cb24-11" title="11">  <span class="kw">let</span> name <span class="fu">=</span> takeFileName dest</a>
<a class="sourceLine" id="cb24-12" title="12">      ctx <span class="fu">=</span> constField <span class="st">&quot;name&quot;</span> name <span class="fu">&lt;&gt;</span></a>
<a class="sourceLine" id="cb24-13" title="13">            constField <span class="st">&quot;script&quot;</span> dest <span class="fu">&lt;&gt;</span></a>
<a class="sourceLine" id="cb24-14" title="14">            constField <span class="st">&quot;description&quot;</span> (itemBody desc')</a>
<a class="sourceLine" id="cb24-15" title="15">  loadAndApplyTemplate <span class="st">&quot;templates/hack.html&quot;</span> ctx <span class="fu">=&lt;&lt;</span> getResourceString</a></code></pre></div>
<p>Adding the hacks to a page is now just loading everything with version <code>&quot;hacks&quot;</code>, and wrapping it in an HTML list.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb25-1" title="1"><span class="ot">addHacks ::</span> <span class="dt">Item</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb25-2" title="2">addHacks item <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb25-3" title="3">  hacks <span class="ot">&lt;-</span> loadAll (fromVersion <span class="fu">$</span> <span class="dt">Just</span> <span class="st">&quot;hacks&quot;</span>)</a>
<a class="sourceLine" id="cb25-4" title="4">  <span class="fu">return</span> item { itemBody <span class="fu">=</span> itemBody item <span class="fu">&lt;&gt;</span> renderHtml (H.ul <span class="fu">$</span> <span class="fu">mapM_</span> asLi hacks) }</a>
<a class="sourceLine" id="cb25-5" title="5">  <span class="kw">where</span> asLi <span class="fu">=</span> H.li <span class="fu">.</span> preEscapedString <span class="fu">.</span> itemBody</a></code></pre></div>
<h2 id="putting-it-all-together"><a href="#putting-it-all-together" id="putting-it-all-together-link" class="titlelink" title="putting-it-all-together">Putting it all together</a></h2>
<p>First, we define three convenience compilers. The first selects between different options based on the underlying identifier.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb26-1" title="1"><span class="ot">byPattern ::</span> a <span class="ot">-&gt;</span> [(<span class="dt">Pattern</span>, a)] <span class="ot">-&gt;</span> <span class="dt">Compiler</span> a</a>
<a class="sourceLine" id="cb26-2" title="2">byPattern def options <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb26-3" title="3">  ident <span class="ot">&lt;-</span> getUnderlying</a>
<a class="sourceLine" id="cb26-4" title="4">  <span class="fu">return</span> <span class="fu">$</span> fromMaybe def (<span class="fu">snd</span> <span class="fu">&lt;$&gt;</span> find ((<span class="ot">`matches`</span> ident) <span class="fu">.</span> <span class="fu">fst</span>) options)</a></code></pre></div>
<p>This can be used to create a compiler that performs initial creation.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb27-1" title="1"><span class="ot">createByPattern ::</span> <span class="dt">Compiler</span> a <span class="ot">-&gt;</span> [(<span class="dt">Pattern</span>, <span class="dt">Compiler</span> a)] <span class="ot">-&gt;</span> <span class="dt">Compiler</span> a</a>
<a class="sourceLine" id="cb27-2" title="2">createByPattern def options <span class="fu">=</span> join <span class="fu">$</span> byPattern def options</a></code></pre></div>
<p>It can also be used to create a compiler that modifies the result of another compiler.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb28-1" title="1"><span class="ot">modifyByPattern ::</span> (b <span class="ot">-&gt;</span> <span class="dt">Compiler</span> a) <span class="ot">-&gt;</span> [(<span class="dt">Pattern</span>, b <span class="ot">-&gt;</span> <span class="dt">Compiler</span> a)] <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> <span class="dt">Compiler</span> a</a>
<a class="sourceLine" id="cb28-2" title="2">modifyByPattern def options x <span class="fu">=</span> join <span class="fu">$</span> byPattern def options <span class="fu">&lt;*&gt;</span> <span class="fu">pure</span> x</a></code></pre></div>
<p>When we instantiate the final page template, we will need to provide a suitable context. Apart from the default fields, my website makes use of two others: a <code>&quot;menu&quot;</code> field containing the menu, and a <code>&quot;source&quot;</code> field that contains a link to the raw (“source”) file for the current page.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb29-1" title="1"><span class="ot">contentContext ::</span> <span class="dt">Compiler</span> (<span class="dt">Context</span> <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb29-2" title="2">contentContext <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb29-3" title="3">  menu <span class="ot">&lt;-</span> getMenu</a>
<a class="sourceLine" id="cb29-4" title="4">  source <span class="ot">&lt;-</span> getResourceFilePath</a>
<a class="sourceLine" id="cb29-5" title="5">  <span class="fu">return</span> <span class="fu">$</span></a>
<a class="sourceLine" id="cb29-6" title="6">    defaultContext <span class="fu">&lt;&gt;</span></a>
<a class="sourceLine" id="cb29-7" title="7">    constField <span class="st">&quot;menu&quot;</span> menu <span class="fu">&lt;&gt;</span></a>
<a class="sourceLine" id="cb29-8" title="8">    constField <span class="st">&quot;source&quot;</span> source</a></code></pre></div>
<p>Furthermore, blog entries need a <code>&quot;date&quot;</code> field, which is extracted from the file name of the post.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb30-1" title="1"><span class="ot">postContext ::</span> <span class="dt">Compiler</span> (<span class="dt">Context</span> <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb30-2" title="2">postContext <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb30-3" title="3">  ctx <span class="ot">&lt;-</span> contentContext</a>
<a class="sourceLine" id="cb30-4" title="4">  <span class="fu">return</span> <span class="fu">$</span> dateField <span class="st">&quot;date&quot;</span> <span class="st">&quot;%B %e, %Y&quot;</span> <span class="ot">`mappend`</span> ctx</a>
<a class="sourceLine" id="cb30-5" title="5"></a>
<a class="sourceLine" id="cb30-6" title="6"><span class="ot">postCtx ::</span> <span class="dt">Context</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb30-7" title="7">postCtx <span class="fu">=</span> <span class="fu">mconcat</span></a>
<a class="sourceLine" id="cb30-8" title="8">  [ modificationTimeField <span class="st">&quot;mtime&quot;</span> <span class="st">&quot;%U&quot;</span></a>
<a class="sourceLine" id="cb30-9" title="9">  , dateField <span class="st">&quot;date&quot;</span> <span class="st">&quot;%B %e, %Y&quot;</span></a>
<a class="sourceLine" id="cb30-10" title="10">  , defaultContext</a>
<a class="sourceLine" id="cb30-11" title="11">  ]</a></code></pre></div>
<p>I extend the default Hakyll configuration with information on how to use <code>rsync</code> to copy the site contents to the server.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb31-1" title="1"><span class="ot">config ::</span> <span class="dt">Configuration</span></a>
<a class="sourceLine" id="cb31-2" title="2">config <span class="fu">=</span> defaultConfiguration</a>
<a class="sourceLine" id="cb31-3" title="3">  { deployCommand <span class="fu">=</span> <span class="st">&quot;rsync --chmod=Do+rx,Fo+r --checksum -ave 'ssh -p 22' \</span></a>
<a class="sourceLine" id="cb31-4" title="4"><span class="st">                     \_site/* --exclude pub athas@sigkill.dk:/var/www/htdocs/sigkill.dk&quot;</span></a>
<a class="sourceLine" id="cb31-5" title="5">  }</a></code></pre></div>
<p>Now we’re ready to describe the entire site.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb32-1" title="1"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb32-2" title="2">main <span class="fu">=</span> hakyllWith config <span class="fu">$</span> <span class="kw">do</span></a></code></pre></div>
<p>CSS files are compressed, data files, my public key, and the <code>robots.txt</code> are copied verbatim.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb33-1" title="1">  match <span class="st">&quot;css/*&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb33-2" title="2">    route   idRoute</a>
<a class="sourceLine" id="cb33-3" title="3">    compile compressCssCompiler</a>
<a class="sourceLine" id="cb33-4" title="4">  match <span class="st">&quot;files/**&quot;</span> static</a>
<a class="sourceLine" id="cb33-5" title="5">  match <span class="st">&quot;pubkey.asc&quot;</span> static</a>
<a class="sourceLine" id="cb33-6" title="6">  match <span class="st">&quot;robots.txt&quot;</span> static</a></code></pre></div>
<p>One of our primary objectives is the ability to write content for the site without having to modify this generator program. Therefore, we define <em>content</em> as a non-hidden file contained in any of the directories <code>me</code>, <code>writings</code>, <code>hacks</code>, <code>programs</code> or <code>projects</code>, as well as any <code>.md</code> file in the root directory. This property is checked by the <code>content</code> pattern.</p>
<p>We divide the content into two sets: content <em>pages</em>, which is all content of types <code>.md</code>, <code>.lhs</code> and <code>.man</code>, and content <em>data</em>, which is the rest.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb34-1" title="1">  <span class="kw">let</span> inContentDir <span class="fu">=</span> <span class="st">&quot;me/**&quot;</span> <span class="fu">.||.</span> <span class="st">&quot;writings/**&quot;</span> <span class="fu">.||.</span> <span class="st">&quot;hacks/**&quot;</span> <span class="fu">.||.</span></a>
<a class="sourceLine" id="cb34-2" title="2">                     <span class="st">&quot;programs/**&quot;</span> <span class="fu">.||.</span> <span class="st">&quot;projects/**&quot;</span> <span class="fu">.||.</span> <span class="st">&quot;*.md&quot;</span></a>
<a class="sourceLine" id="cb34-3" title="3">      nothidden <span class="fu">=</span> complement <span class="st">&quot;**/.**&quot;</span> <span class="fu">.&amp;&amp;.</span> complement <span class="st">&quot;.*/**&quot;</span></a>
<a class="sourceLine" id="cb34-4" title="4">      content <span class="fu">=</span> inContentDir <span class="fu">.&amp;&amp;.</span> nothidden</a>
<a class="sourceLine" id="cb34-5" title="5">      contentPages <span class="fu">=</span> content <span class="fu">.&amp;&amp;.</span> fromRegex <span class="st">&quot;\\.(md|lhs|man)$&quot;</span></a>
<a class="sourceLine" id="cb34-6" title="6">      contentData <span class="fu">=</span> content <span class="fu">.&amp;&amp;.</span> complement contentPages</a></code></pre></div>
<p>Content data is copied verbatim, as it is expected to be images and similar non-processable data.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb35-1" title="1">  match contentData static</a></code></pre></div>
<p>Content pages will end up as HTML files. This is conceptually a simple process: they are added to list of pages contained in the menu, processed by a <em>content compiler</em>, which is <code>manCompiler</code> for manpages, and <code>contentCompiler</code> (which we will see later) for all other files, although everything gets instantiated with the same template in the end. Some pages also need special generated content: the hacks-page needs a list of hacks. These are special-cased in an intermediate step.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb36-1" title="1">  match contentPages <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb36-2" title="2">    addToMenu</a>
<a class="sourceLine" id="cb36-3" title="3">    route <span class="fu">$</span> setExtension <span class="st">&quot;html&quot;</span></a>
<a class="sourceLine" id="cb36-4" title="4">    compile <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb36-5" title="5">      context <span class="ot">&lt;-</span> contentContext</a>
<a class="sourceLine" id="cb36-6" title="6">      createByPattern contentCompiler [(<span class="st">&quot;**.man&quot;</span>, manCompiler)]</a>
<a class="sourceLine" id="cb36-7" title="7">        <span class="fu">&gt;&gt;=</span> modifyByPattern <span class="fu">return</span> [(<span class="st">&quot;hacks/index.md&quot;</span>, addHacks)]</a>
<a class="sourceLine" id="cb36-8" title="8">        <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/default.html&quot;</span> context</a>
<a class="sourceLine" id="cb36-9" title="9">        <span class="fu">&gt;&gt;=</span> relativizeUrls</a></code></pre></div>
<p>The group <code>&quot;source&quot;</code> contains the source files of all literate programs. This is practical, as the processed literate program will be an HTML file, and thus probably no longer compilable by the literate system. While the user could in some cases copy the text from the browser into a source file (this is possible for literate Haskell), it is more convenient to have the original source file available. Source files are, of course, copied verbatim.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb37-1" title="1">  match contentPages <span class="fu">$</span> version <span class="st">&quot;source&quot;</span> static</a></code></pre></div>
<p>The group <code>&quot;hacks&quot;</code> contains small program descriptions generated by <code>hackCompiler</code>. It is included by <code>addHacks</code>.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb38-1" title="1">  match <span class="st">&quot;hacks/scripts/*&quot;</span> <span class="fu">$</span> version <span class="st">&quot;hacks&quot;</span> <span class="fu">$</span> compile hackCompiler</a></code></pre></div>
<p>For the blog, there are two main tasks: first, we must create a page for every post; second, we must create an overview page. A blog post is simply a Markdown file in the <code>&quot;blog/&quot;</code> subdirectory. Note that this is not matched by <code>contentPages</code>.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb39-1" title="1">  <span class="kw">let</span> blogArticles <span class="fu">=</span> <span class="st">&quot;blog/*-*-*-*.md&quot;</span> <span class="fu">.&amp;&amp;.</span> hasNoVersion</a></code></pre></div>
<p>Each post post gives rise to a corresponding HTML file, which uses the post template. The template expects a date field, whose value we extract from the file name. Importantly, individual blog articles are <em>not</em> added to the menu - there would quickly be far too many.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb40-1" title="1">  match blogArticles <span class="fu">$</span> version <span class="st">&quot;source&quot;</span> static</a>
<a class="sourceLine" id="cb40-2" title="2"></a>
<a class="sourceLine" id="cb40-3" title="3">  match blogArticles <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb40-4" title="4">    route <span class="fu">$</span> setExtension <span class="st">&quot;html&quot;</span></a>
<a class="sourceLine" id="cb40-5" title="5">    compile <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb40-6" title="6">      postCtx <span class="ot">&lt;-</span> postContext</a>
<a class="sourceLine" id="cb40-7" title="7">      contentCompiler</a>
<a class="sourceLine" id="cb40-8" title="8">        <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/post.html&quot;</span>    postCtx</a>
<a class="sourceLine" id="cb40-9" title="9">        <span class="fu">&gt;&gt;=</span> saveSnapshot <span class="st">&quot;content&quot;</span></a>
<a class="sourceLine" id="cb40-10" title="10">        <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/default.html&quot;</span> postCtx</a>
<a class="sourceLine" id="cb40-11" title="11">        <span class="fu">&gt;&gt;=</span> relativizeUrls</a></code></pre></div>
<p>The posts list is created by a template. The blog posts are sorted by date, with the date encoded into the filename of the blog entry. The created page is <code>&quot;blog/index.html&quot;</code> rather than <code>&quot;blog.html&quot;</code> in order for blog entries to be considered children of the blog entry in the menu.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb41-1" title="1">  create [<span class="st">&quot;blog/index.html&quot;</span>] <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb41-2" title="2">    addToMenu</a>
<a class="sourceLine" id="cb41-3" title="3">    route idRoute</a>
<a class="sourceLine" id="cb41-4" title="4">    compile <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb41-5" title="5">      ctx <span class="ot">&lt;-</span> contentContext</a>
<a class="sourceLine" id="cb41-6" title="6">      posts <span class="ot">&lt;-</span> recentFirst <span class="fu">=&lt;&lt;</span> loadAll blogArticles</a>
<a class="sourceLine" id="cb41-7" title="7">      <span class="kw">let</span> ctx' <span class="fu">=</span> constField <span class="st">&quot;title&quot;</span> <span class="st">&quot;Blog&quot;</span> <span class="fu">&lt;&gt;</span></a>
<a class="sourceLine" id="cb41-8" title="8">                 listField <span class="st">&quot;posts&quot;</span> postCtx (<span class="fu">return</span> posts) <span class="fu">&lt;&gt;</span></a>
<a class="sourceLine" id="cb41-9" title="9">                 ctx</a>
<a class="sourceLine" id="cb41-10" title="10">      makeItem <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb41-11" title="11">          <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/posts.html&quot;</span> ctx'</a>
<a class="sourceLine" id="cb41-12" title="12">          <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/default.html&quot;</span> ctx'</a>
<a class="sourceLine" id="cb41-13" title="13">          <span class="fu">&gt;&gt;=</span> relativizeUrls</a></code></pre></div>
<p>As the final touch on the blog, we produce an Atom feed. I have no particular reason for choosing Atom over the alternatives, except that it seems slightly more modern. Hakyll seems to support most formats, so I can add more if I feel like it.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb42-1" title="1">  create [<span class="st">&quot;atom.xml&quot;</span>] <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb42-2" title="2">    route idRoute</a>
<a class="sourceLine" id="cb42-3" title="3">    compile <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb42-4" title="4">      <span class="kw">let</span> feedCtx <span class="fu">=</span> postCtx <span class="ot">`mappend`</span> bodyField <span class="st">&quot;description&quot;</span></a>
<a class="sourceLine" id="cb42-5" title="5">      posts <span class="ot">&lt;-</span> <span class="fu">fmap</span> (<span class="fu">take</span> <span class="dv">10</span>) <span class="fu">.</span> recentFirst <span class="fu">=&lt;&lt;</span></a>
<a class="sourceLine" id="cb42-6" title="6">               loadAllSnapshots blogArticles <span class="st">&quot;content&quot;</span></a>
<a class="sourceLine" id="cb42-7" title="7">      <span class="kw">let</span> feedConfiguration <span class="fu">=</span> <span class="dt">FeedConfiguration</span></a>
<a class="sourceLine" id="cb42-8" title="8">            { feedTitle       <span class="fu">=</span> <span class="st">&quot;Troels Henriksen's blog&quot;</span></a>
<a class="sourceLine" id="cb42-9" title="9">            , feedDescription <span class="fu">=</span> <span class="st">&quot;What some hacker has written&quot;</span></a>
<a class="sourceLine" id="cb42-10" title="10">            , feedAuthorName  <span class="fu">=</span> <span class="st">&quot;Troels Henriksen&quot;</span></a>
<a class="sourceLine" id="cb42-11" title="11">            , feedAuthorEmail <span class="fu">=</span> <span class="st">&quot;athas@sigkill.dk&quot;</span></a>
<a class="sourceLine" id="cb42-12" title="12">            , feedRoot        <span class="fu">=</span> <span class="st">&quot;http://sigkill.dk&quot;</span></a>
<a class="sourceLine" id="cb42-13" title="13">            }</a>
<a class="sourceLine" id="cb42-14" title="14">      renderAtom feedConfiguration feedCtx posts</a></code></pre></div>
<p>Finally, HTML templates are, of course, handled by the default template compiler.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb43-1" title="1">  match <span class="st">&quot;templates/*&quot;</span> <span class="fu">$</span> compile templateCompiler</a></code></pre></div>
<p>We’re done with the main function. All we need to do now is some fleshing out. To start with, static files are merely copied into position.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb44-1" title="1"><span class="ot">static ::</span> <span class="dt">Rules</span> ()</a>
<a class="sourceLine" id="cb44-2" title="2">static <span class="fu">=</span> route idRoute <span class="fu">&gt;&gt;</span> compile copyFileCompiler <span class="fu">&gt;&gt;</span> <span class="fu">return</span> ()</a></code></pre></div>
<p>Compiling content pages is done with the default <code>pandocCompiler</code>, but we extend it slightly with a transformation that makes every headline link to itself. First, we define the function that transforms a <code>Header</code> block into a <code>Header</code> block with a self-link.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb45-1" title="1"><span class="ot">selfLinkHeader ::</span> <span class="dt">Block</span> <span class="ot">-&gt;</span> <span class="dt">Block</span></a>
<a class="sourceLine" id="cb45-2" title="2">selfLinkHeader (<span class="dt">Header</span> n (ident, classes, kvs) b) <span class="fu">=</span></a>
<a class="sourceLine" id="cb45-3" title="3">  <span class="dt">Header</span> n (ident, classes, kvs) [b']</a>
<a class="sourceLine" id="cb45-4" title="4">  <span class="kw">where</span> b' <span class="fu">=</span> <span class="dt">Link</span> (ident <span class="fu">&lt;&gt;</span> <span class="st">&quot;-link&quot;</span>, [<span class="st">&quot;titlelink&quot;</span>], []) b (<span class="ch">'#'</span> <span class="fu">:</span> ident, ident)</a>
<a class="sourceLine" id="cb45-5" title="5">selfLinkHeader x <span class="fu">=</span> x</a></code></pre></div>
<p>Then we can define our <code>contentCompiler</code> as a <code>pandocCompiler</code> with an additional transformation step.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb46-1" title="1"><span class="ot">contentCompiler ::</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb46-2" title="2">contentCompiler <span class="fu">=</span> pandocCompilerWithTransform</a>
<a class="sourceLine" id="cb46-3" title="3">                  defaultHakyllReaderOptions</a>
<a class="sourceLine" id="cb46-4" title="4">                  defaultHakyllWriterOptions <span class="fu">$</span></a>
<a class="sourceLine" id="cb46-5" title="5">                  walk selfLinkHeader</a></code></pre></div>
<p>Compiling man pages is done using the system <code>groff</code> program. The output from <code>groff</code> will contain control characters (notably backspaces), which we process with <code>col -b</code> to generate plain text. Finally, we insert the text into an HTML <code>pre</code> element to preserve the whitespace formatting.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb47-1" title="1"><span class="ot">manCompiler ::</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb47-2" title="2">manCompiler <span class="fu">=</span> getResourceString</a>
<a class="sourceLine" id="cb47-3" title="3">              <span class="fu">&gt;&gt;=</span> withItemBody (unixFilter <span class="st">&quot;groff&quot;</span> (<span class="fu">words</span> <span class="st">&quot;-m mandoc -T utf8&quot;</span>)</a>
<a class="sourceLine" id="cb47-4" title="4">                                <span class="fu">&gt;=&gt;</span> unixFilter <span class="st">&quot;col&quot;</span> [<span class="st">&quot;-b&quot;</span>]</a>
<a class="sourceLine" id="cb47-5" title="5">                                <span class="fu">&gt;=&gt;</span> <span class="fu">return</span> <span class="fu">.</span> renderHtml <span class="fu">.</span> H.pre <span class="fu">.</span> H.toHtml)</a></code></pre></div>
<p>And that’s it.</p>
    </div>

    <div id="footer">
      <a href="http://jaspervdj.be/hakyll/index.html" id="hakyllLink">Powered by Hakyll</a>

      <span id="dates">
        
        
      </span>
    </div>
  </body>
</html>
